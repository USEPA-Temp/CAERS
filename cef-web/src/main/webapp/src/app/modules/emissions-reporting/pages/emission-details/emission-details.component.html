<div>
    <div class="card mb-3">
        <div class="card-header text-center">
            <strong>Process Information</strong>
        </div>
        <div class="card-body">
          <div *ngIf="process && reportingPeriod">
            <div class="row pb-2">
                <div class="col-sm-6 col-md-2"><strong>Unit ID:</strong></div>
                <div class="col-sm-6 col-md-6">{{unitIdentifier}}</div>
            </div>

            <div class="row pb-2">
                <div class="col-sm-6 col-md-2"><strong>Process ID:</strong></div>
                <div class="col-sm-6 col-md-2">{{process.emissionsProcessIdentifier}}</div>
                <div class="col-sm-6 col-md-2"><strong>Reporting Period:</strong></div>
                <div class="col-sm-6 col-md-2">{{reportingPeriod.reportingPeriodTypeCode.shortName}}</div>
                <div class="col-sm-6 col-md-2"><strong>Operating Status:</strong></div>
                <div class="col-sm-6 col-md-2">{{process.operatingStatusCode.description}}</div>
            </div>
          </div>

          <div *ngIf="reportingPeriod">
            <div class="row pb-2">
                <div class="col-sm-6 col-md-2"><strong>Calculation Material:</strong></div>
                <div class="col-sm-6 col-md-2">{{reportingPeriod.calculationMaterialCode.description}}</div>
                <div class="col-sm-6 col-md-2"><strong>Calculation Value:</strong></div>
                <div class="col-sm-6 col-md-2">{{reportingPeriod.calculationParameterValue}}</div>
                <div class="col-sm-6 col-md-2"><strong>Calculation UoM:</strong></div>
                <div class="col-sm-6 col-md-2">{{reportingPeriod.calculationParameterUom.description}}</div>
            </div>
                
            <div class="row">
                <div class="col-sm-6 col-md-2"><strong>Calculation Parameter:</strong></div>
                <div class="col-sm-6 col-md-2">{{reportingPeriod.calculationParameterTypeCode.description}}</div>
            </div>
          </div>
        </div>
    </div>

    <form [formGroup]="emissionForm" (ngSubmit)="onSubmit()">
        <div class="card mb-3">
            <div class="card-header text-center">
                <strong>Emission Information</strong>
                <div class="float-right" *ngIf="emissionForm.disabled && !createMode && !readOnlyMode">
                    <button type="button" class="btn btn-primary" (click)="onEdit()">Edit</button>
                </div>
            </div>
            <div class="card-body">

                <div *ngIf="readOnlyMode && emission">
                    <div class="row pb-2">
                        <div class="col-sm-6 col-md-2"><strong>Pollutant Name:</strong></div>
                        <div class="col-sm-6 col-md-2">{{emission.pollutant.pollutantName}}</div>
                        <div class="col-sm-6 col-md-2"><strong>Pollutant Code:</strong></div>
                        <div class="col-sm-6 col-md-2">{{emission.pollutant.pollutantCode}}</div>
                        <div class="col-sm-6 col-md-2"><strong>CAS ID:</strong></div>
                        <div class="col-sm-6 col-md-2">{{emission.pollutant.pollutantCasId}}</div>
                    </div>

                    <div class="row pb-2">
                        
                        <div class="col-sm-4 col-lg-2"><strong>Calculation Method:</strong></div>
                        <div class="col-sm-8 col-lg-10">{{emission.emissionsCalcMethodCode.description}}</div>
                    </div>

                    <div>
                        <div class="row pb-2">
                            <div class="col-sm-4 col-lg-2"><strong>Emission Factor:</strong></div>
                            <div class="col-sm-8 col-lg-4" *ngIf="!emission.formulaIndicator">{{emission.emissionsFactor}}</div>
                            <div class="col-sm-8 col-lg-4" *ngIf="emission.formulaIndicator">{{emission.emissionsFactorFormula}}</div>
                            <div class="col-sm-4 col-lg-2"><strong>Emissions Factor Description:</strong></div>
                            <div class="col-sm-8 col-lg-4">{{emission.emissionsFactorText}}</div>
                        </div>

                        <div class="row pb-2">
                            <div class="col-sm-4 col-lg-2"><strong>Emission Factor Numerator UoM:</strong></div>
                            <div class="col-sm-8 col-lg-4">{{emission.emissionsNumeratorUom?.code}}</div>
                            <div class="col-sm-4 col-lg-2"><strong>Emission Factor Denominator UoM:</strong></div>
                            <div class="col-sm-8 col-lg-4">{{emission.emissionsDenominatorUom?.code}}</div>
                        </div>
                    </div>

                    <div class="row pb-2">
                        <div class="col-sm-4 col-lg-2"><strong>Total Emissions:</strong></div>
                        <div class="col-sm-8 col-lg-4">{{emission.totalEmissions}}</div>
                        <div for="emissionsUomCodeSelect" class="col-sm-4 col-lg-2"><strong>Emissions UoM:</strong></div>
                        <div class="col-sm-8 col-lg-4">{{emission.emissionsUomCode?.code}}</div>
                    </div>

                    <div class="row">
                        <div for="emissionCommentsInput" class="col-sm-4 col-lg-2"><strong>Comments:</strong></div>
                        <div class="col-sm-8 col-lg-10">{{emission.comments}}</div>
                    </div>
                </div>

                <div *ngIf="!readOnlyMode">
                    <div class="row pb-2">
                        <label for="pollutantSelect" class="col-sm-4 col-lg-2 col-form-label"><strong>Pollutant:</strong></label>
                        <div class="col-sm-8 col-lg-5">
                            <input [attr.aria-multiline]="null" id="pollutantSelect" type="text" class="form-control" formControlName="pollutant" [ngbTypeahead]="searchPollutants" [editable]="false" [inputFormatter]="pollutantFormatter" [resultFormatter]="pollutantFormatter"/>
                            <app-validation-message [control]="emissionForm.controls.pollutant"></app-validation-message>
                        </div>
                        <label for="pollutantCodeInput" class="col-sm-4 col-lg-2 col-form-label"><strong>Pollutant Code:</strong></label>
                        <div class="col-sm-8 col-lg-3">
                            <input type="text" class="form-control" id="pollutantCodeInput" [value]="emissionForm.value.pollutant?.pollutantCode" disabled>
                        </div>
                    </div>
                    <div class="row pb-5">
                        <label for="pollutantNameInput" class="col-sm-4 col-lg-2 col-form-label"><strong>Pollutant Name:</strong></label>
                        <div class="col-sm-8 col-lg-5">
                            <input type="text" class="form-control" id="pollutantNameInput" [value]="emissionForm.value.pollutant?.pollutantName" disabled>
                        </div>
                        <label for="pollutantCasIdInput" class="col-sm-4 col-lg-2 col-form-label"><strong>CAS ID:</strong></label>
                        <div class="col-sm-8 col-lg-3">
                            <input type="text" class="form-control" id="pollutantCasIdInput" [value]="emissionForm.value.pollutant?.pollutantCasId" disabled>
                        </div>
                    </div>

                    <div class="row pb-2">
                        
                        <label for="emissionsCalcMethodCodeSelect" class="col-sm-4 col-lg-2 col-form-label"><strong>Calculation Method:</strong></label>
                        <div class="col-sm-8 col-lg-10">
                            <select type="text" class="form-control" id="emissionsCalcMethodCodeSelect" formControlName="emissionsCalcMethodCode" [compareWith]="formUtils.compareCode">
                                <option [ngValue]="null"></option>
                                <option *ngFor="let opt of methodValues" [ngValue]="opt">{{opt.description}}</option>
                            </select>
                            <app-validation-message [control]="emissionForm.controls.emissionsCalcMethodCode"></app-validation-message>
                        </div>
                    </div>

                    <div class="row pb-3 justify-content-end" *ngIf="epaEmissionFactor && !emissionForm.disabled">
                        <div>
                            <button type="button" class="btn btn-success mr-2" (click)="openSearchEfModal()">Search for Emission Factor</button>
                            <div class="validation-message" *ngIf="!emissionForm.get('pollutant').valid">
                                A pollutant must be selected to search for an Emission Factor.
                            </div>
                        </div>
                    </div>

                    <div class="row pb-2">
                        <label for="emissionFactorInput" class="col-sm-4 col-lg-2 col-form-label"><strong>Emission Factor:</strong></label>
                        <div class="col-sm-8 col-lg-4" *ngIf="!emissionForm.get('formulaIndicator').value">
                            <input type="number" class="form-control" id="emissionFactorInput" formControlName="emissionsFactor" [readonly]="epaEmissionFactor">
                            <app-validation-message [control]="emissionForm.controls.emissionsFactor"></app-validation-message>
                            <span class="validation-message" [hidden]="!emissionForm.hasError('efFactorLessThanOrEqualToZero') || !emissionForm.controls.emissionsFactor.dirty">Emission Factor must be greater than zero.</span>
                        </div>
                        <div class="col-sm-8 col-lg-4" *ngIf="emissionForm.get('formulaIndicator').value">
                            <input type="text" class="form-control" id="emissionFactorInput" formControlName="emissionsFactorFormula" [readonly]="true">
                            <app-validation-message [control]="emissionForm.controls.emissionsFactorFormula"></app-validation-message>
                        </div>
                        <label for="emissionsFactorTextInput" class="col-sm-4 col-lg-2 col-form-label"><strong>Emissions Factor Description:</strong></label>
                        <div class="col-sm-8 col-lg-4">
                            <textarea class="form-control" id="emissionsFactorTextInput" formControlName="emissionsFactorText"></textarea>
                            <app-validation-message [control]="emissionForm.controls.emissionsFactorText"></app-validation-message>
                        </div>
                    </div>

                    <div class="pb-2" *ngIf="emissionForm.get('formulaIndicator').value" formGroupName="formulaVariables">
                        <div class="row" *ngFor="let variable of formulaVariables">
                            <label for="{{variable.code + 'Input'}}" class="col-sm-4 col-lg-2 col-form-label"><strong>{{variable.code}} - {{variable.description}}:</strong></label>
                            <div class="col-sm-8 col-lg-4">
                                <input type="number" class="form-control" id="{{variable.code + 'Input'}}" [formControlName]="variable.code">
                                <app-validation-message [control]="getFormulaVariableForm().get(variable.code)"></app-validation-message>
                                <div class="validation-message" *ngIf="emissionForm.getError('invalidSulfurRange')">
                                    If the supplemental calculation parameter type code is percent sulfur content, the value must be between 0.01 and 10.
                                </div>
                                <div class="validation-message" *ngIf="emissionForm.getError('invalidAshRange')">
                                    If the supplemental calculation parameter type code is percent ash content, the value must be between 0.01 and 30.
                                </div>
                            </div>
                        </div>
                    </div>

                    <fieldset [disabled]="epaEmissionFactor">
                        <div class="row pb-2">
                            <label for="emissionsNumeratorSelect" class="col-sm-4 col-lg-2 col-form-label"><strong>Emission Factor Numerator UoM:</strong></label>
                            <div class="col-sm-8 col-lg-4">
                                <select type="text" class="form-control" id="emissionsNumeratorSelect" formControlName="emissionsNumeratorUom" [compareWith]="formUtils.compareCode">
                                    <option [ngValue]="null"></option>
                                    <option *ngFor="let opt of numeratorUomValues" [ngValue]="opt">{{opt.code}}</option>
                                </select>
                                <app-validation-message [control]="emissionForm.controls.emissionsNumeratorUom"></app-validation-message>
                                <div class="validation-message" *ngIf="efNumeratorMismatch">
                                    The Emission Factor Numerator UoM ({{failedNumDesc}}) 
                                    cannot be converted into the Total Emissions UoM ({{failedTotalDesc}}) - 
                                    Calculation cannot be completed.
                                </div>
                            </div>
                            <label for="emissionsDenominatorSelect" class="col-sm-4 col-lg-2 col-form-label"><strong>Emission Factor Denominator UoM:</strong></label>
                            <div class="col-sm-8 col-lg-4">
                                <select type="text" class="form-control" id="emissionsDenominatorSelect" formControlName="emissionsDenominatorUom" [compareWith]="formUtils.compareCode">
                                    <option [ngValue]="null"></option>
                                    <option *ngFor="let opt of denominatorUomValues" [ngValue]="opt">{{opt.code}}</option>
                                </select>
                                <app-validation-message [control]="emissionForm.controls.emissionsDenominatorUom"></app-validation-message>
                                <div class="validation-message" *ngIf="efDenominatorMismatch">
                                    The Reporting Period Calculation UoM ({{failedRpCalcDesc}}) 
                                    cannot be converted into the Emission Factor Denominator UoM ({{failedDenomDesc}}) - 
                                    Calculation cannot be completed.
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <div class="row pb-2">
                        <label for="overallControlPercentInput" class="col-sm-4 col-lg-2 col-form-label"><strong>Overall Control %:</strong></label>
                        <div class="col-sm-8 col-lg-4">
                            <input type="number" class="form-control" id="overallControlPercentInput" formControlName="overallControlPercent">
                            <app-validation-message [control]="emissionForm.get('overallControlPercent')"></app-validation-message>
                        </div>
                    </div>

                    <div class="row pb-2">
                        <label for="totalEmissionsInput" class="col-sm-4 col-lg-2 col-form-label"><strong>Total Emissions:</strong></label>
                        <div class="col-sm-8 col-lg-4">
                            <input type="number" class="form-control" id="totalEmissionsInput" formControlName="totalEmissions" [readOnly]="!getTotalManualEntry().value">
                            <app-validation-message [control]="emissionForm.controls.totalEmissions"></app-validation-message>
                            <div class="validation-message" *ngIf="emissionForm.errors && (emissionForm.dirty || emissionForm.touched)">
                                <div *ngIf="emissionForm.getError('emissionsCalculated')">
                                    The Total Emissions must be recalculated.
                                </div>
                            </div>
                        </div>
                        <label for="emissionsUomCodeSelect" class="col-sm-4 col-lg-2 col-form-label"><strong>Emissions UoM:</strong></label>
                        <div class="col-sm-8 col-lg-4">
                            <select type="text" class="form-control" id="emissionsUomCodeSelect" formControlName="emissionsUomCode" [compareWith]="formUtils.compareCode">
                                <option [ngValue]="null"></option>
                                <option *ngFor="let opt of numeratorUomValues" [ngValue]="opt">{{opt.code}}</option>
                            </select>
                            <app-validation-message [control]="emissionForm.controls.emissionsUomCode"></app-validation-message>
                            <div class="validation-message" *ngIf="efNumeratorMismatch">
                                The Emission Factor Numerator UoM ({{failedNumDesc}}) 
                                cannot be converted into the Total Emissions UoM ({{failedTotalDesc}}) - 
                                Calculation cannot be completed.
                            </div>
                            <div class="validation-message" *ngIf="emissionForm.getError('emissionsUomCodeCurie')">
                                The UoM for pollutant code 605 must be 'CURIE'.
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <div class="float-right form-group form-check" *ngIf="!getCalcMethodCodeValue()?.totalDirectEntry">
                                <input type="checkbox" class="form-check-input" id="manualEntryCb" formControlName="totalManualEntry" >
                                <label for="manualEntryCb" class="form-check-label"><strong>I prefer to calculate the total emissions of this pollutant</strong></label>
                            </div>
                        </div>
                    </div>

                    <div class="row pb-2" *ngIf="!getCalcMethodCodeValue()?.totalDirectEntry && getTotalManualEntry().value">
                        <label for="emissionCalcCommentInput" class="col-sm-4 col-lg-2 col-form-label"><strong>Description of Calculation:</strong></label>
                        <div class="col-sm-8 col-lg-10">
                            <textarea rows="3" class="form-control" maxlength="4000" id="emissionCalcCommentInput" formControlName="calculationComment"></textarea>
                            <div class="validation-message" *ngIf="emissionForm.get('calculationComment').errors 
                                    && (emissionForm.get('calculationComment').dirty || emissionForm.get('calculationComment').touched)">
                                <div *ngIf="emissionForm.get('calculationComment').getError('required')">
                                    Description of Calculation field is required when using an emission factor and choosing to perform the calculations yourself.
                                </div>

                                <div *ngIf="emissionForm.get('calculationComment').getError('maxlength')">
                                    Value cannot exceed {{emissionForm.get('calculationComment').getError('maxlength').requiredLength}} characters.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <label for="emissionCommentsInput" class="col-sm-4 col-lg-2 col-form-label"><strong>Comments:</strong></label>
                        <div class="col-sm-8 col-lg-10">
                            <textarea rows="3" class="form-control" maxlength="400" id="emissionCommentsInput" formControlName="comments"></textarea>
                            <div class="validation-message" *ngIf="emissionForm.get('comments').errors && (emissionForm.get('comments').dirty || emissionForm.get('comments').touched)">
                                <div *ngIf="emissionForm.get('comments').getError('required')">
                                    You must enter an explanation of the total emissions calculation when the 
                                    {{getCalcMethodCodeValue()?.description}} calculation method is selected.
                                </div>

                                <div *ngIf="emissionForm.get('comments').getError('maxlength')">
                                    Value cannot exceed {{emissionForm.get('comments').getError('maxlength').requiredLength}} characters.
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </form>
    <div class="float-right pb-3 pr-3" *ngIf="!readOnlyMode">
        <span *ngIf="!getTotalManualEntry().value && !emissionForm.disabled">
            <button type="button" class="btn btn-success mr-2" (click)="onCalculate()">Calculate Emissions</button>
        </span>
        <button type="button" class="btn btn-primary mr-2" [routerLink]="[processUrl]">Cancel</button>
        <button type="submit" class="btn btn-success" (click)="onSubmit()" [disabled]="emissionForm.disabled">Save</button>
    </div>
    <div class="float-right pb-3 pr-3" *ngIf="readOnlyMode">
        <button type="button" class="btn btn-primary mr-2" [routerLink]="[processUrl]">Back</button>
    </div>
</div>